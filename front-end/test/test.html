<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="qunit/qunit/qunit.css">
    <title>Squt parse tests</title>
    <script type="text/javascript">
    	var jsErrors = [];
	    window.onerror = function(errorMessage) {
	      jsErrors.push(errorMessage);
	    };
    </script>
    <script type="text/javascript" src="../lib/d3.v3/d3.js"></script>
	
	<script type="text/javascript" src="../lib/Object.identical.js/Object.identical.js"></script>
	
    <style type="text/css">
		.hidden {
			display: none;
		}
		
		.test_result {
			margin: 10px;
			font-family: Courier;
		}
		
    	.success {
			color: green;
    	}
		.warn {
			color: orange;
    	}    	
		.error {
			color: red;
    	}
    </style>
  </head>
  <body>
  	<iframe id="squt" src="../squt.html" onload="start()" class="hidden"></iframe><br />
  	This page :
  	<ul>
  		<li>compares processed MySQL parse results with expected ones.</li>
  		<li>checks if the query parsing didn't throw any warning or error.</li>
  		<li>ensures that building the graph didn't throw any error.</li>
  	</ul>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="qunit/qunit/qunit.js"></script>
	<script src="qunit-reporter-junit/qunit-reporter-junit.js"></script>
	
	<div id="report" class="hidden"></div>
  	<script type="text/javascript">
		QUnit.jUnitReport = function(report) {
			d3.select("#report").text(report.xml);
		};
		
	  	var ifr;
  		var queries;
  		var current_query=-1;
		var pattern = d3.select(".test_pattern.hidden").node();
		
		function start() {
		  	ifr = document.getElementById("squt").contentWindow;
		  	d3.text("../list_samples.php",function(text) {
		  		queries=text.split(/,/g);
		  		if (queries.length > 0) {
					current_query = 0;
					test_next_query();
		  		}
		  	});
		}
	  	
	  	function test_next_query() {
	  		if (queries[current_query] === undefined)
	  			return;
			var sql_name=queries[current_query].replace(/^[0-9]+\-(.*)\.sql/g,'$1');
			
			d3.text(
				"../querysamples/"+queries[current_query],
				function (textquery) {
					d3.json(
						"../analyze.php",
						function (processed_json) {
							if (fileExists(expected_json_file) {
		d3.json(
								"../querysamples/"+queries[current_query].replace(/\.sql$/g,'_expected.json'),
								function (expected_json) {
									test("query "+sql_name+" test", function() {
										processed_json=objectToLowerCase(processed_json);
										expected_json=objectToLowerCase(expected_json);
										ok (Object.identical(processed_json, expected_json),"Parse results are not the same as expected : "+JSON.stringify(processed_json)+" vs "+JSON.stringify(expected_json));
										
										if (Object.identical(processed_json, expected_json)) {
											equal(undefined,processed_json.Error,JSON.stringify(processed_json.Error));
											equal(undefined,processed_json.Warning,JSON.stringify(processed_json.Warning));
											
											jsErrors = [];
											try {
												ifr.build(processed_json);
											}
											catch(e) {
												jsErrors.push(e);
											}
											deepEqual(jsErrors.length,0,"The graph has been generated with one or several error(s)");
										}
									});
							  		current_query++;
									test_next_query();
								}
							);
						}
					)
					.header("Content-Type","application/x-www-form-urlencoded")
					.send("POST","query="+textquery.replace(/\n/g,' '));
				}
			);
	  	}
	  	
	  	function objectToLowerCase(o) {
	  		var o2 = {};
	  		for(var x in o) {
	  			if (o !== null) {
		  			if (typeof o[x] === "object") {
		  				o2[x.toLowerCase()] = objectToLowerCase(o[x]);
		  			}
		  			else {
		  				o2[x.toLowerCase()] = o[x].toLowerCase();
		  			}
	  			}
	        }
	  		return o2;
	  	}

		function fileExists(url) {
			var http = new XMLHttpRequest();
    			http.open('HEAD', url, false);
    			http.send();
    			return http.status!=404;
		}
  	</script>
  </body>
</html>
