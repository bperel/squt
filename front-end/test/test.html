<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Squt parse tests</title>
    <script type="text/javascript">
    	var jsErrors = [];
	    window.onerror = function(errorMessage) {
	      jsErrors.push(errorMessage);
	    };
    </script>
    <script type="text/javascript" src="../lib/d3.v3/d3.js"></script>
	
	<script type="text/javascript" src="../lib/Object.identical.js/Object.identical.js"></script>
	
    <style type="text/css">
		.hidden {
			display: none;
		}
		
		.test_result {
			margin: 10px;
			font-family: Courier;
		}
		
    	.success {
			color: green;
    	}
		.warn {
			color: orange;
    	}    	
		.error {
			color: red;
    	}
    </style>
  </head>
  <body>
  	<iframe id="squt" src="../squt.html" onload="start()" class="hidden"></iframe><br />
  	This page :
  	<ul>
  		<li>compares processed MySQL parse results with expected ones.</li>
  		<li>checks if the query parsing didn't throw any warning or error.</li>
  		<li>ensures that building the graph didn't throw any error.</li>
  	</ul>
  	<div class="test_pattern hidden">
  		Test : <span class="test_name"></span>
  		<div class="test_result">
	  		<div class="compare success hidden">
	  			Parse results are the same as expected.
	  		</div>
	  		<div class="compare error hidden">
	  			Parse results are not the same as expected.
	  			<br />
	  			<table>
	  				<tr>
	  					<td>
	  						Processed :
	  					</td>
	  					<td>
	  						Expected :
	  					</td>
	  				</tr>
	  				<tr>
	  					<td>
	  						<textarea rows="30" cols="50" class="processed"></textarea>
	  					</td>
	  					<td>
	  						<textarea rows="30" cols="50" class="expected"></textarea>
	  					</td>
	  				</tr>
	  			</table>
	  		</div>
	  		<div class="parse success hidden">
	  			The query has been parsed without errors.
	  		</div>
	  		<div class="parse warn hidden">
	  			The query has been parsed with one or several warning(s) :<span class="warn_details"></span>
	  		</div>
	  		<div class="parse error hidden">
	  			The query has been parsed with one or several error(s) :<span class="error_details"></span>
	  		</div>
	  		
	  		<div class="graph success hidden">
	  			The graph has been generated without errors.
	  		</div>
	  		<div class="graph error hidden">
	  			The graph has been generated with one or several error(s) :<span class="error_details"></span>
	  		</div>
	  	</div>
  	</div>
  	<script type="text/javascript">
	  	var ifr;
  		var queries;
  		var current_query=-1;
		var pattern = d3.select(".test_pattern.hidden").node();
		
		function start() {
		  	ifr = document.getElementById("squt").contentWindow;
		  	d3.text("../list_samples.php",function(text) {
		  		queries=text.split(/,/g);
		  		if (queries.length > 0) {
					current_query = 0;
					test_next_query();
		  		}
		  	});
		}
	  	
	  	function test_next_query() {
	  		if (queries[current_query] === undefined)
	  			return;
			var sql_name=queries[current_query].replace(/^[0-9]+\-(.*)\.sql/g,'$1');
			
	  		var test_section=d3.select(pattern.cloneNode(true));
			test_section.attr("class","test_pattern");
			test_section.select(".test_name").text(sql_name);
			document.body.appendChild(test_section.node());
			d3.text(
				"../querysamples/"+queries[current_query],
				function (textquery) {
					d3.json(
						"../analyze.php",
						function (processed_json) {
							d3.json(
								"../querysamples/"+queries[current_query].replace(/\.sql$/g,'_expected.json'),
								function (expected_json) {
									processed_json=objectToLowerCase(processed_json);
									expected_json=objectToLowerCase(expected_json);
									if (Object.identical(processed_json, expected_json)) {
										if (processed_json.Error) {
											test_section.select(".parse.error").attr("class","parse error")
															.select(".error_details").text(JSON.stringify(processed_json.Error));
										}
										if (processed_json.Warning) {
											test_section.select(".parse.warn").attr("class","parse warn")
															.select(".warn_details").text(JSON.stringify(processed_json.Warning));
										}
										if (! processed_json.Error && ! processed_json.Warning) {
											test_section.select(".parse.success").attr("class","parse success");
										}
										
										jsErrors = [];
										try {
											ifr.build(processed_json);
										}
										catch(e) {
											jsErrors.push(e);
										}
										if (jsErrors.length == 0) {
											test_section.select(".graph.success").attr("class","graph success");
										}
										else {
											test_section.select(".graph.error").attr("class","graph error")
												.select(".error_details").text("\n"+jsErrors.join("\n"));
										}
										
										test_section.select(".compare.success").attr("class","compare success");
									}
									else {	
										test_section.select(".compare.error").attr("class","compare error");
										test_section.select(".processed").text(JSON.stringify(processed_json));
										test_section.select(".expected" ).text(JSON.stringify(expected_json ));
									}
							  		current_query++;
									test_next_query();
								}
							);
						}
					)
					.header("Content-Type","application/x-www-form-urlencoded")
					.send("POST","query="+textquery.replace(/\n/g,' '));
				}
			);
	  	}
	  	
	  	function objectToLowerCase(o) {
	  		var o2 = {};
	  		for(var x in o) {
	  			if (o !== null) {
		  			if (typeof o[x] === "object") {
		  				o2[x.toLowerCase()] = objectToLowerCase(o[x]);
		  			}
		  			else {
		  				o2[x.toLowerCase()] = o[x].toLowerCase();
		  			}
	  			}
	        }
	  		return o2;
	  	}
  	</script>
  </body>
</html>